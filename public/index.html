<html>
  <title>Battle Kards</title>
  <head>
    <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
  </head>
  <body>
    <div id="app">
      <div v-if="gameStatus === undefined">
        <div class="centerWindow">
          <span>
            Connecting to server...
          </span>
        </div>
      </div>
      <div v-else-if="gameStatus === 'waitingForAnotherPlayer'">
        <div class="centerWindow">
          <span>
            Waiting for another player to join...
          </span>
        </div>
      </div>
      <div v-else-if="gameStatus === 'gameOver'">
        <div class="centerWindow">
          <span>
            <button onclick="window.location.reload();">
              Play again?
            </button>
          </span>
        </div>
      </div>
      <div v-else-if="gameStatus === 'playing'">
        <div id="gameContainer">
          <div id="details" v-show="windowWidth > windowHeight">
            <div class="turn">
              <span>
                Curent turn: {{ this.myPlayerId === this.playersTurn ? 'Me' : 'Other player' }}
              </span>
              <button v-if="myPlayerId === playersTurn" v-on:click="endTurn">
                End turn
              </button>
            </div>
          </div>
          <div id="game">
            <div class="bar">
              <div class="deck flexEven">
                <div class="iconContainer">
                  <img src="images/deck.svg" alt="Deck:" class="icon"/>
                  <span class="iconTitle">x&nbsp;{{ opponent.deckSize }}</span>
                </div>
              </div>
              <div class="shields">
                <div class="iconContainer">
                  <img src="images/shield.svg" alt="Shields:" class="icon"/>
                  <span class="iconTitle">x&nbsp;{{ opponent.shieldsSize }}</span>
                </div>
              </div>
              <div class="hand flexEven">
                <div class="iconContainer right">
                  <img src="images/card.svg" alt="Cards:" class="icon"/>
                  <span class="iconTitle">x&nbsp;{{ opponent.handSize }}</span>
                </div>
              </div>
            </div>
            <div id="opponent">
              <div class="magic scrollX">
                <div class="scrollXCardContainer">
                  <div v-for="n in 5" class="card cardPlaceholder"></div>
                </div>
              </div>
              <div class="monsters scrollX">
                <div class="scrollXCardContainer">
                  <div v-for="n in 5" class="card cardPlaceholder"></div>
                </div>
              </div>
            </div>
            <hr />
            <div id="me">
              <div class="monsters scrollX">
                <div class="scrollXCardContainer">
                  <div v-for="n in 5" class="card cardPlaceholder"></div>
                </div>
              </div>
              <div class="magic scrollX">
                <div class="scrollXCardContainer">
                  <div v-for="n in 5" class="card cardPlaceholder"></div>
                </div>
              </div>
              <div class="hand scrollX">
                <div class="scrollXCardContainer" v-bind:style="{width: myPlayer.hand.length * 12 + 'vh'}">
                  <div v-for="card in myPlayer.hand" class="card">
                    <div class="title" v-bind:title="card.name">
                      <span>
                        {{ card.name }}
                      <span>
                    </div>
                    <div class="atk">
                      <span>
                        Atk: {{ card.attributes.attack }}
                      </span>
                    </div>
                    <div class="def">
                      <span>
                        Def: {{ card.attributes.defense }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div id="bottomBar" class="bar">
              <div class="deck flexEven">
                <div class="iconContainer">
                  <img src="images/deck.svg" alt="Deck:" class="icon"/>
                  <span class="iconTitle">x&nbsp;{{ myPlayer.deckSize }}</span>
                </div>
              </div>
              <div class="shields">
                <div class="iconContainer">
                  <img src="images/shield.svg" alt="Shields:" class="icon"/>
                  <span class="iconTitle">x&nbsp;{{ myPlayer.shieldsSize }}</span>
                </div>
              </div>
              <div class="flexEven">

              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-else>
        Invalid game status
      </div>
    </div>
  </body>

  <script src="https://unpkg.com/vue/dist/vue.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <!-- TODO move into own .js file -->
  <script>
    var socket = io();
    var vm = new Vue({
      el: '#app',
      data: {
        windowHeight: undefined,
        windowWidth: undefined,
        gameStatus: undefined,
        myPlayerId: undefined,
        playersTurn: undefined,
        opponent: undefined,
        myPlayer: undefined
      },
      // bind event handlers to the `handleResize` method (defined below)
      beforeDestroy: function () {
        window.removeEventListener('resize', this.handleResize);
      },
      created: function() {
        window.addEventListener('resize', this.handleResize);
        this.handleResize();

        socket.on('waitingForAnotherPlayer', function() {
          console.log('waitingForAnotherPlayer');
          this.gameStatus = 'waitingForAnotherPlayer';
        }.bind(this));

        socket.on('gameStarted', function(response) {
          console.log('gameStarted', response);
          this.gameStatus = 'playing';
          this.myPlayerId = response.playerId;
          this.playersTurn = response.playersTurn;
          this.opponent = {
            deckSize: response.opponentsDeckSize,
            shieldsSize: response.opponentsShieldsSize,
            handSize: response.opponentsHandSize
          };
          this.myPlayer = {
            deckSize: response.myDeckSize,
            shieldsSize: response.myShieldsSize,
            hand: response.myHand
          };
        }.bind(this));

        socket.on('turnEnded', function(response) {
          console.log('turnEnded', response);
          this.playersTurn = response.playersTurn;
          if (this.playersTurn === this.myPlayerId) {
            this.myPlayer.hand.push(response.cardDrawn);
            this.myPlayer.deckSize = response.myDeckSize;
          } else {
            this.opponent.deckSize = response.opponentsDeckSize;
          }
        }.bind(this));

        socket.on('win', function(message) {
          console.log('win', message);
          this.gameStatus = 'gameOver';
          alert('You won! ' + message);
        }.bind(this));

        socket.on('invalidMove', function(message) {
          console.warn('Invalid move:', message);
        });

      },
      methods: {
        handleResize: function() {
          this.windowHeight = window.innerHeight;
          this.windowWidth = window.innerWidth;
        },
        endTurn: function() {
          console.log('end my turn');
          socket.emit('endTurn');
        }
      }
    });
  </script>
</html>
